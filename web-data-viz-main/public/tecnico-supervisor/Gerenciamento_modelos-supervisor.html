<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modelos - Cortex</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../base/navbar.css">
  <link rel="stylesheet" href="/public/css/gerenciamento_geral.css">
</head>
<body>
  <nav class="barra-lateral">
    <a class="item-logo">
      <img src="../assets/icon/menu-aberto.png" alt="Logo Cortex" class="logotipo">
      <span class="texto-logo">Cortex</span>
    </a>

    <a class="item-navegacao" href="./dash_tecnico-supervisor.html">
      <img src="../assets/icon/graficos.png" id="dash-zona" alt="">
      <span class="texto" id="texto-dash">Dashboard Alerta</span>
    </a>

    <div class="divisor"></div>

    <a class="item-navegacao" href="./gerenciamento_de_cliente-supervisor.html">
      <img src="../assets/icon/icons8-curso-atribuir-80.png" id="atribuicao" alt="">
      <span class="texto">Clientes</span>
    </a>

    <a class="item-navegacao" href="./gerenciamento_de_funcionario-supervisor.html">
      <img src="../assets/icon/gestor-de-projeto.png" id="gerenciamento" alt="">
      <span class="texto">Funcionários</span>
    </a>

    <a class="item-navegacao" href="./modelosGerenciamento-supervisor.html">
      <img src="../assets/icon/modelo.png" id="modelo" alt="">
      <span class="texto">Modelos</span>
    </a>

    <a class="item-notificacao" href="./zona-supervisor.html">
      <img src="../assets/icon/sino.png" id="sino" alt="">
      <span class="texto-notificacao" id="notificacoes">Zonas</span>
    </a>

    <div class="divisor"></div>

    <a class="item-usuario" href="./perfil-supervisor.html">
      <img src="../assets/icon/teste-perfil.webp" alt="Avatar José" class="avatar-usuario">
      <span class="texto-usuario">José</span>
    </a>

    <div class="divisor"></div>

    <a class="item-notificacao">
      <img src="../assets/icon/sair (1).png" id="sair-imagem" alt="">
      <span class="texto-notificacao" id="sair">Sair</span>
    </a>
  </nav>

  <main class="conteudo-principal">
    <div class="container-modelos">
      <div class="header-modelos">
        <h1>Gerenciamento de Modelos</h1>
      </div>

      <div class="barra-acoes">
        <div class="area-pesquisa-filtro">
          <div class="pesquisa-cortex">
            <span class="material-icons">search</span>
            <input type="text" id="pesquisar-input" placeholder="Pesquisar modelo...">
          </div>
          <div class="filtro-coluna">
            <label for="filtro-select">Filtrar por:</label>
            <select id="filtro-select">
              <option value="todos" selected>Todos os campos</option>
              <option value="nome">Nome</option>
              <option value="descricao">Descrição</option>
              <option value="zona">Zona</option>
              <option value="cliente">Cliente</option>
              <option value="ip">IP</option>
              <option value="hostname">Hostname</option>
              <option value="status">Status</option>
            </select>
          </div>
        </div>
        
        <div class="acoes-container">
          <button id="btn-adicionar" class="btn btn-primario">
            Adicionar <b>+</b>
          </button>
        </div>
      </div>

      <section class="container-tabela">
        <div class="envoltorio-tabela">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Descrição</th>
                <th>Zona</th>
                <th>Cliente</th>
                <th>IP</th>
                <th>Hostname</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tabela-modelos-corpo"></tbody>
          </table>
        </div>
        <div class="tabela-rodape"></div>
      </section>
    </div>
  </main>

    <div id="sobreposicao-formulario" class="sobreposicao-formulario">
    <div class="painel-formulario">
      <div class="cabecalho-formulario">
        <h2 id="modal-title">Adicionar Modelo</h2>
        <button class="btn-fechar" id="btn-fechar-modal">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <div class="corpo-formulario">
        <form id="form-modelo">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
              <div class="campo-form">
                <label for="nome-modelo">Nome:</label>
                <input type="text" id="nome-modelo" placeholder="Nome do seu modelo" required>
              </div>

              <div class="campo-form">
                <label for="descricao-modelo">Descrição:</label>
                <textarea id="descricao-modelo" placeholder="Faça uma Descrição" required></textarea>
              </div>

              <div class="campo-form">
                <label for="zona-modelo">Zona de disponibilidade:</label>
                <select id="zona-modelo" required>
                  <option value="">Selecione...</option>
                </select>
              </div>

              <div class="campo-form">
                <label for="cliente-modelo">Cliente:</label>
                <select id="cliente-modelo" required>
                  <option value="">Selecione...</option>
                </select>
              </div>

              <div class="campo-form">
                <label for="ip-modelo">IP:</label>
                <input type="text" id="ip-modelo" placeholder="123.4.567.89" required>
              </div>

              <div class="campo-form">
                <label for="hostname-modelo">Hostname:</label>
                <input type="text" id="hostname-modelo" placeholder="User" required>
              </div>

              <div class="campo-form">
                <label for="status-modelo">Status:</label>
                <select id="status-modelo" required>
                  <option value="ativo">Ativo</option>
                  <option value="inativo">Inativo</option>
                </select>
              </div>
              </div>

<div style="display: flex; flex-direction: column; gap: 1.5rem; background-color: #E2E8F0; padding: 1.5rem; border-radius: 12px; border: 2px solid var(--cor-borda);">
              <h3 style="color: var(--cor-primaria); font-size: 1.25rem; font-weight: 700; margin: 0; padding-bottom: 1rem; border-bottom: 2px solid var(--cor-primaria);">Parâmetros</h3>

              <div class="campo-form">
                <label for="tempo-modelo">Tempo dos parâmetros (em Min):</label>
                <input type="text" id="tempo-modelo" placeholder="Ex: 30" required>
              </div>

              <div class="campo-form">
                <label for="limite-cpu-modelo">Limite CPU (%):</label>
                <input type="text" id="limite-cpu-modelo" placeholder="80%" required>
              </div>

              <div class="campo-form">
                <label for="limite-disco-modelo">Limite Disco (%):</label>
                <input type="text" id="limite-disco-modelo" placeholder="60%" required>
              </div>

              <div class="campo-form">
                <label for="limite-ram-modelo">Limite RAM (%):</label>
                <input type="text" id="limite-ram-modelo" placeholder="75%" required>
              </div>

              <div class="campo-form">
                <label for="limite-gpu-modelo">Limite GPU (%):</label>
                <input type="text" id="limite-gpu-modelo" placeholder="92%" required>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="rodape-formulario">
        <button type="button" class="btn btn-cancelar" id="btn-cancelar">Cancelar</button>
        <button id="btn-salvar" type="submit" form="form-modelo" class="btn btn-primario">Salvar Modelo</button>
      </div>
    </div>
  </div>

  <script>
const nomeInput = document.getElementById('nome-modelo');
const descricaoInput = document.getElementById('descricao-modelo');
const zonaInput = document.getElementById('zona-modelo');
const clienteInput = document.getElementById('cliente-modelo');
const ipInput = document.getElementById('ip-modelo');
const hostnameInput = document.getElementById('hostname-modelo');
const statusModeloInput = document.getElementById('status-modelo');
const tempoInput = document.getElementById('tempo-modelo');
const limiteCpuInput = document.getElementById('limite-cpu-modelo');
const limiteDiscoInput = document.getElementById('limite-disco-modelo');
const limiteRamInput = document.getElementById('limite-ram-modelo');
const limiteGpuInput = document.getElementById('limite-gpu-modelo');

const tabelaCorpo = document.getElementById('tabela-modelos-corpo');
const form = document.getElementById('form-modelo');
const overlay = document.getElementById('sobreposicao-formulario');
const tituloModal = document.getElementById('modal-title');
const btnAdicionar = document.getElementById('btn-adicionar');
const btnFechar = document.getElementById('btn-fechar-modal');
const btnCancelar = document.getElementById('btn-cancelar');

let linhaEditando = null;
const fk_empresa = sessionStorage.EMPRESA_USUARIO;

const pesquisaInput = document.getElementById('pesquisar-input');
const filtroSelect = document.getElementById('filtro-select');

function abrirModal(modo = 'novo') {
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
    tituloModal.textContent = modo === 'novo' ? 'Adicionar Modelo' : 'Editar Modelo';
    if (modo === 'novo') form.reset();
}

function fecharModal() {
    overlay.classList.remove('show');
    document.body.style.overflow = '';
    linhaEditando = null;
}

const mapaColunas = {
    'todos': 'todos',
    'id': 0,
    'nome': 1,
    'descricao': 2,
    'zona': 3,
    'cliente': 4,
    'ip': 5,
    'hostname': 6, 
    'status': 7 
};

function aplicarPesquisa() {
    const termoPesquisa = pesquisaInput.value.toLowerCase().trim();
    const colunaFiltro = filtroSelect.value;
    const linhas = tabelaCorpo.querySelectorAll('tr');

    linhas.forEach(linha => {
        let textoParaPesquisar = '';

        if (colunaFiltro === 'todos') {
            for (let i = 0; i < linha.children.length - 1; i++) {
                textoParaPesquisar += linha.children[i].textContent.toLowerCase() + ' ';
            }
        } else {
            const indiceCelula = mapaColunas[colunaFiltro];
            textoParaPesquisar = linha.children[indiceCelula].textContent.toLowerCase();
        }

        if (textoParaPesquisar.includes(termoPesquisa)) {
            linha.style.display = '';
        } else {
            linha.style.display = 'none';
        }
    });
}

pesquisaInput.addEventListener('input', aplicarPesquisa);
filtroSelect.addEventListener('change', aplicarPesquisa);

btnAdicionar.addEventListener('click', () => abrirModal('novo'));
btnFechar.addEventListener('click', fecharModal);
btnCancelar.addEventListener('click', fecharModal);

window.addEventListener("load", () => {
    if (!fk_empresa) {
        console.error("ID da empresa não encontrado na sessão.");
        alert("Erro ao carregar dados. Por favor, faça o login novamente.");
        return;
    }

    buscarDadosDoFormulario(fk_empresa);

    fetch(`/modelos/listar/${fk_empresa}`)
        .then(res => res.json())
        .then(modelos => {
            console.log("Modelos recebidos:", modelos);

            tabelaCorpo.innerHTML = "";
            modelos.forEach(m => {
                const tr = document.createElement("tr");
                tr.setAttribute("data-id", m.id_modelo);
                tr.setAttribute("data-zona", m.fk_zona);
                tr.setAttribute("data-cliente", m.fk_cliente);
                tr.setAttribute("data-tempo", m.tempo_parametros || '');
                tr.setAttribute("data-limite-cpu", m.limite_cpu || '');
                tr.setAttribute("data-limite-disco", m.limite_disco || '');
                tr.setAttribute("data-limite-ram", m.limite_ram || '');
                tr.setAttribute("data-limite-gpu", m.limite_gpu || '');
                
                tr.innerHTML = `
                    <td>${m.id_modelo}</td>
                    <td>${m.nome}</td>
                    <td>${m.descricao || '-'}</td>
                    <td>${m.zona_nome || '-'}</td>
                    <td>${m.cliente_nome || '-'}</td>
                    <td>${m.ip || '-'}</td>
                    <td>${m.hostname || '-'}</td>
                    <td><span class="badge ${m.status}">${m.status}</span></td>
                    <td>
                        <div class="coluna-acoes">
                            <button class="btn-icone" title="Editar"><span class="material-icons">edit</span></button>
                            <button class="btn-icone" title="Excluir"><span class="material-icons">delete</span></button>
                        </div>
                    </td>
                `;
                tabelaCorpo.appendChild(tr);
            });
        })
        .catch(erro => {
            console.error("Erro ao carregar modelos:", erro);
            alert("Erro ao carregar modelos");
        });
});

function buscarDadosDoFormulario(idEmpresa) {
    fetch('/empresaDados/formulario/' + idEmpresa)
        .then(function(resposta) { 
            if (resposta.ok) {
                return resposta.json();
            } else {
                throw new Error('Falha ao buscar os dados do formulário.');
            }
        })
        .then(function(dadosRecebidos) { 
            popularSelects(dadosRecebidos);
        })
        .catch(function(error) {
            console.error('Erro ao buscar dados do formulário:', error);
        });
}

function popularSelects(dados) {
    const selectZona = zonaInput;
    const selectCliente = clienteInput;

    selectZona.innerHTML = '<option value="" disabled selected>Selecione uma zona...</option>';
    selectCliente.innerHTML = '<option value="" disabled selected>Selecione um cliente...</option>';

    console.log(dados);
    
    for (let i = 0; i < dados.length; i++) {
        const item = dados[i];
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.nome;

        if (item.tipo === 'zona') {
            selectZona.appendChild(option);
        } else if (item.tipo === 'cliente') {
            selectCliente.appendChild(option);
        }
    }
}

tabelaCorpo.addEventListener('click', (e) => {
    const botao = e.target.closest('.btn-icone');
    if (!botao) return;

    const linha = botao.closest('tr');
    const id_modelo = linha.getAttribute("data-id");
    const acao = botao.getAttribute('title');

    if (acao === 'Editar') {
        linhaEditando = linha;
        nomeInput.value = linha.children[1].textContent;
        descricaoInput.value = linha.children[2].textContent === '-' ? '' : linha.children[2].textContent;
        zonaInput.value = linha.getAttribute("data-zona");
        clienteInput.value = linha.getAttribute("data-cliente");
        ipInput.value = linha.children[5].textContent === '-' ? '' : linha.children[5].textContent;
        hostnameInput.value = linha.children[6].textContent === '-' ? '' : linha.children[6].textContent;
        statusModeloInput.value = linha.children[7].textContent.trim().toLowerCase();
        tempoInput.value = linha.getAttribute("data-tempo");
        limiteCpuInput.value = linha.getAttribute("data-limite-cpu");
        limiteDiscoInput.value = linha.getAttribute("data-limite-disco");
        limiteRamInput.value = linha.getAttribute("data-limite-ram");
        limiteGpuInput.value = linha.getAttribute("data-limite-gpu");
        abrirModal('editar');
    } else if (acao === 'Excluir') {
        if (confirm("Deseja realmente excluir este modelo?")) {
            fetch(`/modelos/deletar/${id_modelo}`, { method: "DELETE" })
                .then(res => {
                    if (res.ok) {
                        linha.remove();
                        alert("Modelo excluído!");
                    } else {
                        alert("Erro ao excluir modelo");
                    }
                })
                .catch(erro => {
                    console.error("Erro ao excluir:", erro);
                    alert("Erro ao excluir modelo");
                });
        }
    }
});

form.addEventListener('submit', (ev) => {
    ev.preventDefault();
    const modelo = {
        nome: nomeInput.value.trim(),
        descricao: descricaoInput.value.trim(),
        fk_zona: zonaInput.value,
        fk_cliente: clienteInput.value,
        ip: ipInput.value.trim(),
        hostname: hostnameInput.value.trim(),
        status: statusModeloInput.value.trim(),
        tempo_parametros: tempoInput.value.trim(),
        limite_cpu: limiteCpuInput.value.trim(),
        limite_disco: limiteDiscoInput.value.trim(),
        limite_ram: limiteRamInput.value.trim(),
        limite_gpu: limiteGpuInput.value.trim()
    };

    if (linhaEditando) {
        const id_modelo = linhaEditando.getAttribute("data-id");

        fetch(`/modelos/atualizar/${id_modelo}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(modelo)
        })
      .then(res => {
            if (res.ok) {
                alert("Modelo atualizado com sucesso!");
                window.location.reload();
            } else {
                alert("Erro ao atualizar modelo");
            }
        })
        .catch(erro => {
            console.error("Erro ao atualizar:", erro);
            alert("Erro ao atualizar modelo");
        });
    } else {
        fetch("/modelos/cadastrar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(modelo)
        })
        .then(res => {
            if (res.ok) {
                alert("Modelo cadastrado com sucesso!");
                window.location.reload();
            } else {
                alert("Erro ao cadastrar modelo");
            }
        })
        .catch(erro => {
            console.error("Erro ao cadastrar:", erro);
            alert("Erro ao cadastrar modelo");
        });
    }

    fecharModal();
});
  </script>
</body>
</html>